---
title: Linux写时拷贝理解
date: 2017-02-18 22:04:27
tags:
---
在最初的UNIX系统里，fork系统调用实现得不够好，fork的时候会复制父进程的整个地址空间给子进程，这样效率非常低。因为需要做这些事情：
1、要为子进程的页表分配页帧。
2、为子进程的页分配页帧。
3、初始化子进程的页表。
4、把父进程的页复制到子进程的页里面去。
这个过程涉及到大量的内存访问，且完全破坏了cache中的内容。而且，费了这么大劲做的事情，在后续几乎没有用。因为子进程一般会用exec执行一个新的程序，之前拷贝的内容就完全没用了。
所以，后面进行了改进。就是现在的写时拷贝技术了。
简单来说，思想很简单，就是父进程和子进程共享页帧，而不是复制页帧。当然在共享的期间，页帧的内容不能被修改，只要父进程和子进程的操作会写入到一个共享的页帧，就会产生一个异常，内核会处理它，把对应的页帧复制一份。这个页帧后续就有2份了。
总之，是一种拖延战术，不到万不得已不去做。

一个进程，有text段、data端、堆、栈这4个部分。这4个部分分别有对应的内存页帧。





