---
title: camera图像处理原理分析
date: 2017-03-08 22:14:06
tags:
	- camera
---
# 1. 人眼视觉
先看看人眼视觉的相关概念。
1.分辨力
是指区分两个发光点的能力。与背景亮度、物体速度、颜色有关。
2.适应性
可以感觉的亮度范围可以达到10的六次方这个数量级。
分为暗适应和亮适应。
暗适应：从亮环境到暗环境后，恢复视觉需要几分钟。
亮适应：从暗环境到亮环境，很快就可以恢复视觉。
3.灰度视觉
当眼睛接收到的光包含所有波长的信号，且其强度大致相等时，表现为非彩色。
白色光照射下，反射率大于80%的，看上去是白色，反射率小于3%的，看上去是黑色。
4.原色系统
分为加色系统和减色系统。
加色系统：RGB就是一个加色系统。用于光源模型。
减色系统：CMY就是减色系统。用于反射或折射模型。
这两种系统中的颜色互为补色。补色是指从白光中取出改颜色得到的颜色。
原色是指不能通过其他颜色混合而得到的颜色。

# 2. 色彩空间
Sensor对光源的响应，和人眼对光谱的响应，其RGB分量是有偏差的，所以就需要对Sensor的进行校正。需要校正的不仅是交叉效应，还有对色彩各分量的响应强度也需要校正。校正方法是用一个色彩校正矩阵来做。
这个校正就是ISP做的事情。另外因为RGB转YUV，也是通过3X3的矩阵来做的，所以很多时候，是把这两件事情一次做了。

RGB这个色彩空间，实际上无法涵盖所有可能的颜色，所以无法有统一的绝对标准。

红色的波长在600到700nm左右，绿色的在500到600nm，蓝色的波长是400到500nm。

RGB和YUV是最常用的色彩空间。
一个最常用的转换公式是：
```
Y = 0.30R + 0.59G + 0.11B 这个大概是3:6:1的比例。绿色最多，蓝色最少。
U = 0.493(B-Y) 这个叫做蓝色色差
V = 0.877(R-Y) 这个叫做红色色差
```
这个公式得到的YUV值，可能出现负值，范围也没有在255之内，对于计算机处理不方便。所以经常对这个公式进行调整。

# 3. 白平衡
# 3.1 色温的定义
把一个黑色物理，从绝对零度开始加热，温度每升高一度，成为1K，温度升高到一定值的时候（可以参考生活中铁被烧红的现象），物理便会发光。温度越高，其色调就越接近蓝色的部分，所谓炉火纯青，就是温度很高了的时候，不够高的时候，是红色的。
日光灯的在5000K左右。白炽灯在3000K左右。
日光平均是5400K左右。阴天的日光是12000K到18000K。

人眼及大脑对色温有一定的心理和生理的自适应性，所以看到的颜色手色温偏移的影响较小，而Sensor则没有。所以拍的照片如果不经过白平衡处理，颜色跟人眼看到的就会有较大的偏差。

随着色温的升高，就需要对色温进行校正，否则在这样的光线条件下，物体表现的颜色就会偏离其本来的颜色。需要降低Sensor对红色的增益，增加对蓝光的增益，同时要考虑整体的亮度保持基本不变。用YUV空间来看的时候，就是Y要保持基本不变。

# 3.2 自动白平衡
自动白平衡是基于假设场景的色彩的平均值落在一个特定的范围里，如果测量得到的结果偏离出这个范围，则调整对应的参数，校正直到平均值落入到设定的范围。
这个处理过程可能基于YUV空间，也可能是基于RGB空间。
对于Sensor来说，通常的校正是通过校正R和B的增益，使得U和V的值在范围内，就实现的白平衡。

# 4. 颜色相关的特效处理

# 4.1 灰阶
灰阶图就是把彩色图片转成黑白的。
理论就是在YUV空间里，把UV都去掉，只剩下Y分量。

# 4.2 复古
复古就是在灰阶的基础上，对UV值额外做一个偏移，把灰度图转成了某种颜色的梯度图。

# 4.3 负片
就是底片相关，就是把颜色都取对应的反色就好了。操作就是用255减去对应的RGB值。


# 5. 亮度感应及曝光
先了解一个概念：感光宽容度。
从最暗到最亮，人眼可以看到其中一个范围，而Sensor能够感受的范围要小得多，这个范围就是感光宽容度。
因为人眼有瞳孔来自动调节对光线的感应。
对于Sensor，应该如何来判断曝光是否正确呢？标准的做法是在YUV空间计算当前的Y值的平均值。通过调节各种曝光参数，使得改均值落在一个目标值附近的时候，就可以认为得到的正确的曝光。
Y的这个均值是多少呢？是18%灰。
一般认为物体的平均反光系数是18%，其色彩均值，可以认为是一种中灰的色调，这样，可以通过对反光率为18%的灰板拍摄，调整曝光参数，使得其颜色接近中等亮度的灰色，Y值为128。然后对于通常的景物，就可以得到正确的曝光了。
这种处理方法对于夜景和雪景不适用。


# 6. 噪点控制
AG的增大，会导致噪点增多。光线较暗，曝光时间长，也会导致噪点增多。
原理上看，是因为曝光时间长，感光元件的温度升高，电流噪声导致的噪点增加。
所以在Sensor里一般集成了降噪处理。


# 7. 数码变焦


# 8. 工频闪
日常生活中的白炽灯这些光源，都是50HZ的工频。灯光在1s内发生了100次变化。
人眼的特点，导致对这种闪烁不敏感。
Sensor有参数可以设置，来降低这种影响。


# 9. 测试工具
1. 分辨率测试图卡
2. 24色色彩测试图卡
3. 几何失真测试图卡
4. 灰阶测试图卡
5. 中性灰测试图卡
6. 全白测试图卡



