---
title: telnet（1）
date: 2018-08-10 22:37:01
tags:
	- 网络

---



telnet协议是tcpip协议族里的一员。是Internet远程登录服务的标准协议。

telnet协议的目的是提供一种相对通用的、双向的、面向8bit字节的通信方法。

telnet的特点：

1、适应异构。

为了适应异构，定义了NVT（Net Virtual Terminal）。作为中间数据。

2、传送远端命令。

ascii码包括95个可打印字符和33个控制字符。

当用户输入控制字符时，NVT把它转换为特殊的可打印字符在网络上传送。到达远端后再转换回来。

3、数据流向。

4、强制命令。

这个是借助于tcp的urgent数据来实现的。

5、选项协商。



# 原理

telnet协议的三大组成部分：

1、NVT .

2、操作协商定义。

3、协商有限状态机。



# NVT

nvt，网络虚拟终端。被client和server采用。

用来建立数据表示和解释的一致性。

NVT包括两部分：

1、out设备。一般为显示器。

2、in设备。

NVT数据格式：

8bit的字节数据。bit7位0，普通数据，bit7位1的，控制命令。

telnet采用一种对称的数据表示。

当client发送data时，把它的本地终端的字符表映射到NVT的字符表上。

接受data时，把NVT的又映射回本地的字符表上。

通信双方都支持一个基本的NVT特性子集。（只能区分什么是data，什么是cmd）。

这样就支持了最低层次上的通信。

在这个基础上，双方在通过NVT命令协商确定更高层次的特性。实现对NVT功能的扩展。

由于终端类型的多样性，telnet协议族就变得庞大起来。



# 操作协商

为什么需要操作协商？

因为最基本的NVT智能接收和显示ascii码，没有编辑能力。所以最基本的NVT没有实际意义。

所以就需要扩展。

telnet的操作协商使用NVT命令。

每条NVT	命令以字节IAC（0xff）开始。

原理是这样的：

只要client或者server要发送cmd而不是data，它就在数据流中插入一个特殊的保留字符，这个保留字符就叫做“解释为命令”（英文为Interpret As Command，缩写IAC）。

当接收方在一个数据流里发送IAC的时候，它就把后面的字节都处理为一个命令序列。

所有的telnet命令如下：

| 名称    | 编码   | 说明            |
| ----- | ---- | ------------- |
| EOF   | 236  | 文件结束符         |
| SUSP  | 237  | 挂起当前进程        |
| ABORT | 238  | 终止进程          |
| EOR   | 239  | 记录结束符         |
| SE    | 240  | 子选项结束         |
| NOP   | 241  | 空操作           |
| DM    | 242  | 数据标记Data Mark |
| BRK   | 243  | 终止符           |
| IP    | 244  | 终止进程          |
| AO    | 245  | 终止输出          |
| AYT   | 246  | 请求应答          |
| EC    | 247  | 终止符           |
| EL    | 248  | 擦除一行          |
| GA    | 249  | 继续            |
| SB    | 250  | 子选项开始         |
| WILL  | 251  | 选项协商          |
| WONT  | 252  | 选项协商          |
| DO    | 253  | 选项协商          |
| DONT  | 254  | 选项协商          |
| IAC   | 255  | IAC           |

只有will、wont、do、dont这4个命令是协商用的。

这4个命令，有6种组合。

| 发送者  | 接受者  | 说明                       |
| ---- | ---- | ------------------------ |
| will | do   | 发送者想要激活某个选项，接受者同意接收改选项请求 |
| will | dont |                          |
| do   | will | 发送者希望接受者激活某个选项，接收者同意     |
| do   | wont |                          |
| wont | dont |                          |
| dont | wont |                          |



接下来分析busybox里的telent.c里的代码。



telnet有两种操作模式：

1、命令模式。

2、会话模式。

默认是会话模式，会话模式下，所有的按键行为都通过网络发送到server端。



telnet的四种操作方式：

1、半双工。

这个是telnet的默认方式。但是现在却很少使用。NVT默认是 一个半双工设备，

2、一次一个字符方式。

3、一次一行方式。

4、行方式。





# 参考资料

1、Telnet协议详解

https://www.cnblogs.com/liang-ling/p/5833489.html

2、Telnet命令模式

https://baike.baidu.com/item/Telnet%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F/9786213?fr=aladdin

3、Telnet4种操作方式

https://blog.csdn.net/hrl7752/article/details/77434542