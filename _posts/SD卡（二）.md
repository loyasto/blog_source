---
title: SD卡（二）
date: 2018-03-06 12:27:52
tags:
	- SD卡
typora-root-url: ..\
---



#SD卡的结构

![SD卡结构](/images/SD卡结构.png)



#8个内部寄存器的介绍

1、CID。

card id。128位。

2、RCA。

相对卡地址。16位。在spi模式下没用。

3、DSR。

驱动存储寄存器。

4、CSD。

卡特别数据。

5、SCR。

sd配置寄存器。

6、OCR。

操作条件寄存器。

7、SSR。

sd状态寄存器。

8、CSR。

卡状态寄存器。

# 命令格式

命令由6个字节组成。分为3段来分析。

```
1、字节1.
	b7和b6固定为01 。
	b5到b0：表示cmd。所以最多可以有64条命令。
2、字节2到字节5 。
	命令参数。可以没有。
3、字节6 。
	b7到b1：为crc校验。
	b0：固定为1 。

```

## 命令分类

命令分为12类，分别叫做class0到class11 。

下面讲解比较重要的。

| 命令   | 参数                | 回应   | 描述               |
| ---- | ----------------- | ---- | ---------------- |
| CMD0 | NONE              | R1   | 复位SD卡。           |
| 8    | VHS+check pattern | R7   | 发送接口状态命令         |
| 9    | NONE              | R1   | 读取卡特定数据寄存器       |
| 10   | NONE              | R1   | 读取卡标志数据寄存器       |
| 16   | 块大小               | R1   | 设置块大小            |
| 17   | 地址                | R1   | 读取一个块的数据         |
| 24   | 地址                | R1   | 写入一个块的数据         |
| 41   | NONE              | R3   | 激活卡初始化过程         |
| 55   | NONE              | R1   | 告诉SD卡，下一个是特定应用命令 |
| 58   | NONE              | R3   | 读取OCR寄存器。        |



每发送一个命令，SD卡都会给出一个应答。用来告诉CPU命令的执行结果。

spi模式下，SD卡的应答可以是R1到R7 。

R1的结果描述如下：

| 位    | 7    | 6    | 5    | 4      | 3     | 2    | 1    | 0    |
| ---- | ---- | ---- | ---- | ------ | ----- | ---- | ---- | ---- |
| 含义   | 固定为0 | 参数错误 | 地址错误 | 擦除序列错误 | crc错误 | 非法命令 | 擦除复位 | 闲置状态 |

R1等于0，就表示成功。

R2到R7的可以参考SD2.0协议。

# spi模式下SD卡操作流程

##初始化

1、初始化与SD卡连接的硬件条件，配置引脚复用。

2、上电延时，大于74个clk。（实际代码里，是用写入10个字节来做的就是80个clk）

3、发送cmd0，复位SD卡。

4、发送cmd8，检查是否支持sd2.0协议。

5、根据不同的协议检查SD卡。

6、取消片选，多发送8个clk，结束初始化。

## 读取数据

1、发送cmd17 

2、接受响应R1

3、接受数据起始令牌0xFE

4、接受数据。

5、接受2个字节的crc，

6、禁止片选后，多发送8个clk。

## 写入数据

1、发送cmd24

2、接收卡响应R1

3、发送写数据起始令牌0XFE

4、发送数据。

5、发送2个字节的伪crc

6、禁止片选后，多发送8个clk。



# stm32下的SD卡操作示例

很简单，就是收发spi的数据。

