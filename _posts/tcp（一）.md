---
title: tcp（一）
date: 2018-02-27 15:58:43
tags:
	- tcp

---



以太网包最大是1518字节。18个字节是以太网帧头（14字节的头加上4个字节校验）。

1500字节是ip包的长度。

ip包的包头最少是20字节，所以里面的数据就是1480字节。

tcp的包头最短也是20字节，tcp有效数据就是1460字节。



一个10MB的文件，就需要被分包为7100多个包。

这么多包，就要编号，这样接收者就可以根据编号把数据重新组装起来。如果有丢包，也可以知道是哪个包丢了。

这个过程是协议栈完成的，应用程序不需要关注。



第一个包的编号是随机产生的，我们就叫1号包。

如果1号包的长度是100字节，那么下一个包的编号应该是101号。我们可以根据抓包看到的编号来推断包的长度。



服务器方式数据，当然是希望能够尽快发送完成，但是发快了，有可能会丢包。

带宽太小、路由器温度太高、缓存溢出都会导致丢包。

最理想的情况是，在线路允许的情况下，达到最高速率。

但是我们怎么知道线路的情况是怎样的呢？那就是慢慢试。

tcp协议为了达到效率和可靠性的统一，设计了一个慢启动的机制。

开始放松，比较慢，根据丢包情况，调整速率。如果丢包，就降速，如果不丢包，就加速。



linux内核里，TCP_INIT_CWND这个常量就是10。刚开始通信的时候，发送方一次性发送10个数据包，然后等待对方的确认，再继续发送。

默认情况下，接收方每收到2个tcp数据包，就要发送一个ack消息。

ack消息包括：1、期待手动的下一个包的编号。2、自己的接收窗口的剩余容量。

发送方得到这2个信息，就可以推算接收方的大概接收速度，从而进行调整。



## tcp断开为什么要4次挥手？

1、仔细看的话，其实是2次，因为tcp是全双工的，所以，sender和receiver都要FIN和ACK。

只不过有一方是被动的。所以看上去就成了4次挥手。如果两边同时断开连接，那么就会进入到CLOSING状态。

然后再转到TIME_WAIT状态。

